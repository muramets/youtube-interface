# ğŸ¬ Render Pipeline â€” Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾

> Ğ­Ñ‚Ğ¾ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±ÑŠÑÑĞ½ÑĞµÑ‚, ĞºĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ Ğ²Ğ¸Ğ´ĞµĞ¾, ĞºĞ°Ğº ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ğ¸ Ğ³Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸, Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ.

---

## Ğ§Ğ°ÑÑ‚ÑŒ 1: ĞĞ±Ñ‰ĞµĞµ Overview

### Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ñ‚Ğ°ĞºĞ¾Ğµ?

ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ **Render** Ğ² UI â€” Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚ÑÑ **Ğ½Ğµ Ğ½Ğ° ĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğµ**, Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Google Cloud. Ğ­Ñ‚Ğ¾ Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚ Ñ‚Ğ°Ğº:

```
Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ â†’ Cloud Function â†’ Cloud Tasks â†’ Cloud Run Job â†’ ffmpeg â†’ R2 â†’ Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ
```

Ğ Ğ°Ğ·Ğ±ĞµÑ€Ñ‘Ğ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºÑƒÑĞ¾Ñ‡ĞµĞº Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼:

### ğŸ§© ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ pipeline

#### 1. Cloud Functions (Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ½Ğ°ĞµÑˆÑŒ)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ Firebase Cloud Functions, ĞºĞ°Ğº Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ğº.
**Ğ Ğ¾Ğ»ÑŒ:** ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ UI ("Ğ½Ğ°Ñ‡Ğ½Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€") Ğ¸ ÑÑ‚Ğ°Ğ²ÑÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ.
**Ğ¤Ğ°Ğ¹Ğ»:** `functions/src/index.ts` â†’ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ `startRender` Ğ¸ `cancelRender`

> Ğ”ÑƒĞ¼Ğ°Ğ¹ Ğ¾Ğ± ÑÑ‚Ğ¾Ğ¼ ĞºĞ°Ğº Ğ¾ **ÑĞµĞºÑ€ĞµÑ‚Ğ°Ñ€Ğµ**, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ¸ ĞºĞ»Ğ°Ğ´Ñ‘Ñ‚ ĞµÑ‘ Ğ² ÑÑ‚Ğ¾Ğ¿ĞºÑƒ.

#### 2. Cloud Tasks (Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¾Ñ‚ Google, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¸Ñ… Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¹.
**Ğ Ğ¾Ğ»ÑŒ:** ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¾Ñ‚ Cloud Function Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Cloud Run Job.
**Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ğ°:** Ğ•ÑĞ»Ğ¸ 10 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ°Ğ¶Ğ¼ÑƒÑ‚ Render Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ²ÑÑ‚Ğ°Ğ½ÑƒÑ‚ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑÑ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ, Ğ° Ğ½Ğµ ÑĞ²Ğ°Ğ»ÑÑ‚ ÑĞµÑ€Ğ²ĞµÑ€.
**ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:** `max-concurrent-dispatches=1` â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 1 Ñ€ĞµĞ½Ğ´ĞµÑ€ Ğ·Ğ° Ñ€Ğ°Ğ·.

> Ğ”ÑƒĞ¼Ğ°Ğ¹ Ğ¾Ğ± ÑÑ‚Ğ¾Ğ¼ ĞºĞ°Ğº Ğ¾ **Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ² Ğ±Ğ°Ğ½ĞºĞµ** â€” Ğ½Ğ¾Ğ¼ĞµÑ€ĞºĞ¸ Ñ€Ğ°Ğ·Ğ´Ğ°Ğ»Ğ¸, Ğ¶Ğ´Ñ‘Ğ¼ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°.

#### 3. Cloud Run Job (Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ»Ğ¾ÑˆĞ°Ğ´ĞºĞ°)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** ĞĞ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Docker-ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ, Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ¸ ÑƒĞ¼Ğ¸Ñ€Ğ°ĞµÑ‚.
**Ğ Ğ¾Ğ»ÑŒ:** Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ, Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ffmpeg, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² R2.
**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:** `cloud-run/render/src/index.ts` + `ffmpeg.ts`
**Ğ ĞµÑÑƒÑ€ÑÑ‹:** 8 CPU, 8 GB RAM â€” Ğ¼Ğ¾Ñ‰Ğ½Ğ°Ñ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°, Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ĞºĞ° Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚.

> Ğ’ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾Ñ‚ Cloud Functions, Cloud Run Job Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ **Ñ‡Ğ°ÑĞ°Ğ¼Ğ¸** (Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ 24 Ñ‡Ğ°ÑĞ°). Cloud Functions ÑƒĞ¼Ğ¸Ñ€Ğ°ÑÑ‚ Ñ‡ĞµÑ€ĞµĞ· 9 Ğ¼Ğ¸Ğ½ÑƒÑ‚.

> Ğ”ÑƒĞ¼Ğ°Ğ¹ Ğ¾Ğ± ÑÑ‚Ğ¾Ğ¼ ĞºĞ°Ğº Ğ¾ **Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ½Ğ¸ĞºĞµ**, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ. Ğ¡Ğ´ĞµĞ»Ğ°Ğ» â€” ÑƒĞ²Ğ¾Ğ»Ğ¸Ğ»ÑÑ.

#### 4. ffmpeg (Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ°)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ open-source Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ°ÑƒĞ´Ğ¸Ğ¾.
**Ğ Ğ¾Ğ»ÑŒ:** Ğ‘ĞµÑ€Ñ‘Ñ‚ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ + Ğ°ÑƒĞ´Ğ¸Ğ¾Ñ‚Ñ€ĞµĞºĞ¸ â†’ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ MP4 Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ğ´Ğ»Ñ YouTube.
**Ğ¤Ğ°Ğ¹Ğ»:** `cloud-run/render/src/ffmpeg.ts`

> Ğ­Ñ‚Ğ¾ Ñ‚Ğ¾ Ğ¶Ğµ ÑĞ°Ğ¼Ğ¾Ğµ, Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ÑÑ‚ DaVinci Resolve Ğ¸Ğ»Ğ¸ Premiere Pro, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ.

#### 5. Cloudflare R2 (Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ¾Ñ‚ Cloudflare, ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾Ğµ Ñ Amazon S3.
**Ğ Ğ¾Ğ»ÑŒ:** Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ MP4 Ñ„Ğ°Ğ¹Ğ»Ñ‹. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ (24 Ñ‡Ğ°ÑĞ°).
**Ğ—Ğ°Ñ‡ĞµĞ¼ R2, Ğ° Ğ½Ğµ Firebase Storage:** R2 = **$0 Ğ·Ğ° ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ**. Firebase Storage Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ Ğ·Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ³Ğ¸Ğ³Ğ°Ğ±Ğ°Ğ¹Ñ‚, ÑĞºĞ°Ñ‡Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼.

#### 6. Firestore (ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ)
**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** Ğ¢Ğ¾ Ğ¶Ğµ ÑĞ°Ğ¼Ğ¾Ğµ Firestore, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ.
**Ğ Ğ¾Ğ»ÑŒ:** Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ° ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ Ğ¸ progress. UI Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (`onSnapshot`) Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.
**ĞŸÑƒÑ‚ÑŒ:** `users/{userId}/channels/{channelId}/videos/{videoId}/renders/{renderId}`

### ğŸ”„ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Render
   â†“
2. UI Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Cloud Function `startRender`
   â†“
3. Cloud Function ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ² Firestore (status: "queued")
   â†“
4. Cloud Function ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ² Cloud Tasks Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
   â†“
5. Cloud Tasks Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Cloud Run Job
   â†“
6. Cloud Run Job:
   a. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ°ÑƒĞ´Ğ¸Ğ¾Ñ‚Ñ€ĞµĞºĞ¸ Ğ¸Ğ· Firebase Storage
   b. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ»Ğ¾Ğ¶ĞºÑƒ Ğ¸Ğ· Firebase Storage
   c. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ffmpeg â†’ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ output.mp4
   d. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ MP4 Ğ² Cloudflare R2
   e. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ signed URL (ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ¶Ğ¸Ğ²Ñ‘Ñ‚ 24 Ñ‡Ğ°ÑĞ°)
   f. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Firestore (status: "complete", downloadUrl: "...")
   â†“
7. UI Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· onSnapshot â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Download
```

### âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ°

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Cancel
   â†“
2. UI Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Cloud Function `cancelRender`
   â†“
3. Cloud Function ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ² Firestore status: "cancelled"
   â†“
4. Cloud Run Job ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ Firestore Ñ‡ĞµÑ€ĞµĞ· onSnapshot
   â†“
5. Cloud Run Job Ğ²Ğ¸Ğ´Ğ¸Ñ‚ "cancelled" â†’ ÑƒĞ±Ğ¸Ğ²Ğ°ĞµÑ‚ ffmpeg Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ â†’ Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ñ‹ â†’ exit(0)
```

---

## Ğ§Ğ°ÑÑ‚ÑŒ 2: ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ—Ğ°Ğ¿ÑƒÑĞº

### Ğ§Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ

1. **Google Cloud CLI** â€” [ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ](https://cloud.google.com/sdk/docs/install)
2. **Docker Desktop** â€” [ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ](https://www.docker.com/products/docker-desktop/)

### Ğ¨Ğ°Ğ³ 1: ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```bash
gcloud auth login
```

ĞÑ‚ĞºÑ€Ğ¾ĞµÑ‚ÑÑ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ â†’ Ğ²Ğ¾Ğ¹Ğ´Ğ¸ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Google, Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ `mytube-46104`.

### Ğ¨Ğ°Ğ³ 2: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Cloud Run Job

```bash
cd cloud-run/render
./deploy.sh
```

Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:
- âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Google Cloud project
- âœ… Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ API
- âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°ÑÑ‚ Docker registry (Artifact Registry)
- âœ… Ğ¡Ğ¾Ğ±ĞµÑ€Ñ‘Ñ‚ Docker image
- âœ… Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ ĞµĞ³Ğ¾ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾
- âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°ÑÑ‚ Cloud Run Job Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸
- âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°ÑÑ‚ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Cloud Tasks

**Ğ’Ñ€ĞµĞ¼Ñ:** ~3-5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ â€” ÑĞ±Ğ¾Ñ€ĞºĞ° Docker image).

### Ğ¨Ğ°Ğ³ 3: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Cloud Functions

```bash
cd ../..   # Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
npx firebase deploy --only functions
```

Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ `startRender` Ğ¸ `cancelRender` Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.

### Ğ¨Ğ°Ğ³ 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°

ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â†’ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ñ‚Ñ€ĞµĞºĞ¸ â†’ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Render â†’ ÑĞ»ĞµĞ´Ğ¸ Ğ·Ğ° Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¾Ğ¼.

---

## Ğ§Ğ°ÑÑ‚ÑŒ 3: ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ ĞĞ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ

### ğŸ” Ğ“Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸

#### Cloud Run Job Ğ»Ğ¾Ğ³Ğ¸ (Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ñ€ĞµĞ½Ğ´ĞµÑ€)

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ [Cloud Console â†’ Cloud Run Jobs](https://console.cloud.google.com/run/jobs?project=mytube-46104)
2. ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° `render-worker`
3. Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° **Executions** â€” Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ²
4. ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº â†’ **Logs** â€” Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ°

Ğ›Ğ¾Ğ³Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ (JSON), ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ:
- `step: "start"` â€” Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾
- `step: "download_complete"` â€” Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑĞºĞ°Ñ‡ĞµĞ½Ñ‹
- `step: "ffmpeg_start"` â€” ffmpeg Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½
- `step: "upload_complete"` â€” Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ² R2
- `step: "complete"` â€” Ğ²ÑÑ‘ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾
- `step: "failed"` â€” Ğ¾ÑˆĞ¸Ğ±ĞºĞ° (ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ `message`)

#### Cloud Functions Ğ»Ğ¾Ğ³Ğ¸

1. [Cloud Console â†’ Cloud Functions](https://console.cloud.google.com/functions?project=mytube-46104)
2. Ğ˜Ğ»Ğ¸ Ğ² Firebase Console â†’ Functions â†’ Logs

#### Cloud Tasks Ğ»Ğ¾Ğ³Ğ¸ (Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)

1. [Cloud Console â†’ Cloud Tasks](https://console.cloud.google.com/cloudtasks?project=mytube-46104)
2. ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ `render-queue` â†’ Ğ²Ğ¸Ğ´Ğ½Ğ¾ pending/running Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

### ğŸ“ˆ Ğ“Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ CPU/RAM Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ°

#### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: Cloud Run â†’ Metrics (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ [Cloud Console â†’ Cloud Run Jobs](https://console.cloud.google.com/run/jobs?project=mytube-46104)
2. ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° `render-worker`
3. Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° **Metrics** â€” Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸:
   - **CPU utilization** â€” Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ CPU (Ğ¿Ñ€Ğ¸ 8 vCPU ffmpeg Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ 600â€“800%)
   - **Memory utilization** â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ RAM (Ğ¿Ñ€Ğ¸ 8Gi Ğ´Ğ»Ñ 1080p Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ ~1-2 GB, Ğ´Ğ»Ñ 4K â€” Ğ´Ğ¾ 4-5 GB)
   - **Startup latency** â€” ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ cold start ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°

> Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ ~1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ. Ğ”Ğ»Ñ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¾Ğ² (>2 Ğ¼Ğ¸Ğ½) â€” ÑĞ°Ğ¼Ñ‹Ğ¹ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ±.

#### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Cloud Monitoring (Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹)

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ [Cloud Monitoring â†’ Metrics Explorer](https://console.cloud.google.com/monitoring/metrics-explorer?project=mytube-46104)
2. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ€ĞµÑÑƒÑ€Ñ: **Cloud Run Job** â†’ `render-worker`
3. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸:
   - `run.googleapis.com/container/cpu/utilizations` â€” CPU Ğ¿Ğ¾ ÑĞ´Ñ€Ğ°Ğ¼
   - `run.googleapis.com/container/memory/utilizations` â€” RAM Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…
   - `run.googleapis.com/container/billable_instance_time` â€” Ğ¾Ğ¿Ğ»Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ

> Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ° Ğ´Ğ½Ğ¸/Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ **Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹** (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Â«ĞµÑĞ»Ğ¸ CPU > 95% Ğ´Ğ¾Ğ»ÑŒÑˆĞµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ â€” Ğ¿Ğ¾ÑĞ»Ğ°Ñ‚ÑŒ emailÂ»).

#### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 3: Ğ›Ğ¾Ğ³Ğ¸ Cloud Run Job (ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº)

Ğ’ Ğ»Ğ¾Ğ³Ğ°Ñ… ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ execution Ñ‚Ñ‹ Ñ‚Ğ°ĞºĞ¶Ğµ ÑƒĞ²Ğ¸Ğ´Ğ¸ÑˆÑŒ:
- Ğ’Ñ€ĞµĞ¼Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ° (download, encode, upload)
- ĞĞ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
- Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆÑ‘Ğ» OOM â€” Ğ»Ğ¾Ğ³ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ `signal: "SIGKILL"` Ğ±ĞµĞ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

#### Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚: Ñ‡Ñ‚Ğ¾ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ½Ğ¾Ñ€Ğ¼Ğ¾Ğ¹

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | 1080p Ñ€ĞµĞ½Ğ´ĞµÑ€ (5 Ğ¼Ğ¸Ğ½ Ğ²Ğ¸Ğ´ĞµĞ¾) | 4K Ñ€ĞµĞ½Ğ´ĞµÑ€ (5 Ğ¼Ğ¸Ğ½ Ğ²Ğ¸Ğ´ĞµĞ¾) |
|---------|---------------------------|------------------------|
| CPU utilization | 600â€“800% (Ğ¸Ğ· 800% max) | 700â€“800% |
| Memory | 1â€“2 GB (Ğ¸Ğ· 8 GB) | 3â€“5 GB |
| Ğ’Ñ€ĞµĞ¼Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ° | ~1â€“2 Ğ¼Ğ¸Ğ½ | ~5â€“8 Ğ¼Ğ¸Ğ½ |
| Cold start | 5â€“15 ÑĞµĞº | 5â€“15 ÑĞµĞº |

### ğŸ’° Ğ“Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ

#### ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ¸Ğ»Ğ»Ğ¸Ğ½Ğ³
[Cloud Console â†’ Billing](https://console.cloud.google.com/billing?project=mytube-46104)

#### ĞŸĞ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | Ğ“Ğ´Ğµ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ | Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ´ĞµĞ½ĞµĞ³ |
|--------|-------------|-----------------|
| **Cloud Run** | Billing â†’ Cloud Run | CPU + RAM Ã— Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹. ~$0.05-0.10 Ğ·Ğ° Ñ€ĞµĞ½Ğ´ĞµÑ€ |
| **Cloud Tasks** | Billing â†’ Cloud Tasks | ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ 1 Ğ¼Ğ»Ğ½ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾. Ğ”Ğ°Ğ»ĞµĞµ $0.40/Ğ¼Ğ»Ğ½ |
| **Artifact Registry** | Billing â†’ Artifact Registry | Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Docker images. ~$0.10/GB/Ğ¼ĞµÑÑÑ† |
| **Firestore** | Firebase Console â†’ Usage | Reads/writes. ~$0.001 Ğ·Ğ° Ñ€ĞµĞ½Ğ´ĞµÑ€ |
| **Firebase Storage** | Firebase Console â†’ Storage | Download bandwidth (ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞ¾Ğ² ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼) |
| **Cloudflare R2** | Cloudflare Dashboard â†’ R2 | Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ: $0.015/GB/Ğ¼ĞµÑÑÑ†. **Download: $0** |

#### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ°

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ |
|-----------|-----------|
| Cloud Run (8 CPU, 5 Ğ¼Ğ¸Ğ½) | ~$0.04 |
| Firebase Storage download | ~$0.01 |
| R2 storage (24 Ñ‡Ğ°ÑĞ°) | ~$0.00 |
| Firestore writes | ~$0.00 |
| **Ğ˜Ñ‚Ğ¾Ğ³Ğ¾** | **~$0.05** |

### âš™ï¸ Ğ§Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ

#### Ğ’ `deploy.sh` (Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ)

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | Ğ§Ñ‚Ğ¾ Ğ¼ĞµĞ½ÑĞµÑ‚ |
|----------|-----------------|------------|
| `CPU` | `8` | ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ´ĞµÑ€. Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ = Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ Ñ€ĞµĞ½Ğ´ĞµÑ€, Ğ´Ğ¾Ñ€Ğ¾Ğ¶Ğµ |
| `MEMORY` | `8Gi` | RAM. Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ÑŒ ĞµÑĞ»Ğ¸ OOM Ğ¿Ñ€Ğ¸ 4K Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ°Ñ… |
| `TIMEOUT` | `86400` (24Ñ‡) | ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ job |
| `MAX_RETRIES` | `2` | Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· retry Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ |

#### Ğ’ Cloud Tasks Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | Ğ§Ñ‚Ğ¾ Ğ¼ĞµĞ½ÑĞµÑ‚ |
|----------|-----------------|------------|
| `max-concurrent-dispatches` | `1` | Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾. 1 = Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ |
| `max-attempts` | `3` | Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ |

Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸:
```bash
gcloud tasks queues update render-queue \
    --location=us-central1 \
    --max-concurrent-dispatches=2
```

### ğŸ”§ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°

Ğ•ÑĞ»Ğ¸ Ñ‚Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ» ĞºĞ¾Ğ´ Ğ² `cloud-run/render/src/`:

```bash
cd cloud-run/render
./deploy.sh    # Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±ĞµÑ€Ñ‘Ñ‚ image Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Job
```

Ğ•ÑĞ»Ğ¸ Ñ‚Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ» Cloud Functions:

```bash
npx firebase deploy --only functions
```

### ğŸš¨ Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

| Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼ | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ |
|---------|---------|---------|
| Ğ ĞµĞ½Ğ´ĞµÑ€ Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ½Ğ° "Queued" | Cloud Tasks Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Job | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ² Cloud Console |
| "Failed to start render" | Cloud Function ÑƒĞ¿Ğ°Ğ»Ğ° | Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ Cloud Functions |
| "Server render failed" | ffmpeg ÑƒĞ¿Ğ°Ğ» Ğ¸Ğ»Ğ¸ OOM | Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ Cloud Run Job |
| ĞšĞ½Ğ¾Ğ¿ĞºĞ° Download Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ | Signed URL Ğ¿Ñ€Ğ¾Ñ‚ÑƒÑ… (>24Ñ‡) Ğ¸Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½ Ğ¸Ğ· R2 | ĞŸĞµÑ€ĞµÑ€ĞµĞ½Ğ´ĞµÑ€Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾ |
| `deploy.sh` Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ | Docker Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ | Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ Docker Desktop, `gcloud auth login` |

### ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

```
cloud-run/render/
â”œâ”€â”€ deploy.sh          # Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ (Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑˆÑŒ ĞµĞ³Ğ¾)
â”œâ”€â”€ Dockerfile         # Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Docker image
â”œâ”€â”€ package.json       # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (firebase-admin, aws-sdk)
â”œâ”€â”€ package-lock.json  # Lockfile Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
â”œâ”€â”€ tsconfig.json      # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ TypeScript
â””â”€â”€ src/
    â”œâ”€â”€ index.ts       # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»: ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ, upload, ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
    â””â”€â”€ ffmpeg.ts      # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ffmpeg ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº

functions/src/
â””â”€â”€ index.ts           # startRender + cancelRender Cloud Functions

src/
â”œâ”€â”€ core/stores/
â”‚   â””â”€â”€ renderQueueStore.ts      # ĞšĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ğ¹ state management
â”œâ”€â”€ features/Render/
â”‚   â””â”€â”€ RenderQueueFAB.tsx       # Floating ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¾Ğ¼
â”œâ”€â”€ components/ui/atoms/
â”‚   â””â”€â”€ RenderStatusBar.tsx      # ĞŸĞ¾Ğ»Ğ¾ÑĞºĞ° Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°
â””â”€â”€ pages/Details/tabs/Editing/
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ RenderControls.tsx    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° Render + Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
    â”‚   â””â”€â”€ RenderProgressBar.tsx # ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾
    â””â”€â”€ services/
        â””â”€â”€ renderService.ts     # Ğ’Ñ‹Ğ·Ğ¾Ğ² Cloud Functions Ğ¸Ğ· UI
```
